var stella={};stella.config={},stella.api={},stella.up={},stella.util={},stella.api.request=function(e,t){if(e.method=e.method.toLowerCase()||"get",e.url=e.url||stella.config.api.url,e.version=e.version||stella.config.api.version,e.projectID=e.projectID||stella.config.projectID,e.auth=e.auth||{},e.auth.session=localStorage.getItem("stellaSession"),"get"===e.method){e.url+="/"+e.projectID,e.url+="/"+e.api.replace(/\./g,"-")+"/",e.url+="?"+stella.util.serialize(e.params);var l=null}if("post"===e.method)l=JSON.stringify(e);var a=new XMLHttpRequest;a.addEventListener("error",function(t){e.xhrError=t,console.log("[stella.js] XHR ERROR: Unable to contact "+stella.config.api.url+" due to network error"),console.log(e)}),a.addEventListener("load",function(e){var l=JSON.parse(e.target.response);if(l.auth?localStorage.setItem("stellaSession",l.auth.session):localStorage.removeItem("stellaSession"),t)return t(l)}),a.open(e.method,e.url,!0),a.setRequestHeader("Stella-Api",e.api),a.setRequestHeader("Stella-Api-Version",e.version),a.setRequestHeader("Stella-Project-Id",e.projectID),a.setRequestHeader("Stella-Auth",btoa(JSON.stringify(e.auth))),a.setRequestHeader("Content-Type","application/json;charset=UTF-8"),a.send(l)},stella.config={api:{url:"https://api.stellaverse.com",version:1},bucket:"cdn.stellaverse.com",projectID:"000000000000",recaptcha:{key:"6LeZ6RMTAAAAAFaHzXK76s60uMlBlKzSe5NsWUL1"}},stella.up.abortUpload=function(e){var t=stella.up.uploads[e];return stella.up.uploaders[e].abort(),stella.up.uploads[e].status="aborted",t.onAbort(stella.up.uploads[e]),stella.up.finalizeUpload(stella.up.uploads[e])},stella.up.finalizeUpload=function(e){if("account"===e.to)var t={method:"post",api:"accounts.files.finalizeUpload",params:{fileURL:e.url}};if("drive"===e.to)t={method:"post",api:"drive.objects.finalizeObjectUpload",projectID:e.projectID,params:{objectID:e.objectID}};stella.api.request(t,function(t){if(t.error)return stella.up.uploads[e.id].status="error",stella.up.uploads[e.id].error=t.error,void e.onError(stella.up.uploads[e.id]);stella.up.uploads[e.id].status="complete",e.onComplete(stella.up.uploads[e.id])})},stella.up.initializeUpload=function(e){stella.util.getActiveAccount();var t=e.to||"drive";e.file;if("account"===t)var l={method:"post",api:"accounts.files.insertFile",params:{file:{name:e.file.name,size:e.file.size}}};if("drive"===t)l={method:"post",api:"drive.objects.insertObject",projectID:e.projectID,params:{locale:e.locale,parentID:e.parentID,objectType:e.objectType,title:e.file.name,filename:e.file.name}};stella.api.request(l,function(l){if(l.error)return stella.up.uploads[e.id].status="error",stella.up.uploads[e.id].error=l.error,console.error(error),console.info(stella.up.uploads[e.id]),void(e.onError&&e.onError(stella.up.uploads[e.id]));if(e.status="initialized","account"===t){var a=l.data.account;localStorage.setItem("stellaAccount",JSON.stringify(a));var o=l.data.file;e.objectID=null,e.url=o.url,e.key=o.key,e.ext=o.ext,e.credentials=o.credentials}if("drive"===t){var s=l.data;e.objectID=s._id,e.url=s.url,e.key=s.key,e.ext=s.ext,e.credentials=s.credentials}stella.up.uploads[e.id]=e,stella.up.uploadFile(stella.up.uploads[e.id]),e.onInit(stella.up.uploads[e.id])})},stella.up.upload=function(e){return window.AWS?(e.id=stella.up.uploads.length,e.status="initializing",e.date={initiated:(new Date).getTime(),completed:0},stella.util.getActiveAccount()?(stella.up.uploads.push(e),void stella.up.initializeUpload(e)):(e.status="error",e.error="You Must Login To Upload A File",console.error("[stella.js] You must login to upload a file."),console.info(e),void e.onError(e))):(console.error("[stella.js] The AWS SDK for Javascript v2.171.0 or greater is required to upload files using Stella Up."),console.info("[stella.js] Visit the following URL for installation instructions:"),console.info("[stella.js] http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-the-jssdk.html"),void alert("You must install the AWS SDK v2.171.0 or greater to use Stella Up. See your console for more details."))},stella.up.uploaders=[],stella.up.uploadFile=function(e){var t=e.bucket||stella.config.bucket,l=new AWS.Credentials({accessKeyId:e.credentials.AccessKeyId,secretAccessKey:e.credentials.SecretAccessKey,sessionToken:e.credentials.SessionToken});AWS.config.region="us-east-1";var a=new AWS.S3({credentials:l,maxRetries:100,params:{Bucket:t}});stella.up.uploaders[e.id]=a.upload({Key:e.key,ACL:"private",ContentType:e.file.type,ContentLength:e.file.size,Body:e.file.buffer,ServerSideEncryption:"AES256"}),stella.up.uploaders[e.id].on("httpUploadProgress",function(t){var l=t.total,a=t.loaded,o=a/l*100;(new Date).getTime(),stella.up.uploads[e.id].date.initiated;stella.up.uploads[e.id].status="uploading",stella.up.uploads[e.id].loaded=a,stella.up.uploads[e.id].total=l,stella.up.uploads[e.id].percent=o,stella.up.uploads[e.id].rate="0Mbps",stella.up.uploads[e.id].remaining="0:00:00",e.onProgress(stella.up.uploads[e.id])}),stella.up.uploaders[e.id].send(function(t,l){t?(stella.up.uploads[e.id].status="error",stella.up.uploads[e.id].error=t,console.error("[stella.js] Upload error, please try again."),e.onError(stella.up.uploads[e.id])):stella.up.uploads[e.id].status="uploaded",stella.up.finalizeUpload(stella.up.uploads[e.id])})},stella.up.uploads=[],stella.util.getActiveAccount=function(){return JSON.parse(localStorage.getItem("stellaAccount"))},stella.util.serialize=function(e,t){var l,a=[];for(l in e)if(e.hasOwnProperty(l)){var o=t?t+"["+l+"]":l,s=e[l];a.push(null!==s&&"object"==typeof s?stella.util.serialize(s,o):encodeURIComponent(o)+"="+encodeURIComponent(s))}return a.join("&")},stella.util.setActiveAccount=function(e){return localStorage.setItem("stellaAccount",JSON.stringify(e)),!0};